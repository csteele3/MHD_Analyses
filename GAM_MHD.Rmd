---
title: "GAM_MHD"
author: "Christen"
date: "March 25, 2020"
output:
  html_document:
    df_print: paged
---

GAM Work with Monarch Health Data



*Overall Research Question 1*
How do the spatial dynamics of OE infection prevalence change within year and between years in the sedentary population of monarch butterflies in the SE U.S.?


*Why use a GAM?*
We do not expect the patterns in disease prevalence as described by our predictor variables to be linear. For example, infection prevalence may experience increases during periods of warm weather such as in late fall and early spring, while mid winter low temperatures may result in a decline in infection prevalence as population density and therefore transmission potential declines. Graphs of the dataset are provided below for visual inspection of the linear or non-linear trends.  

*Dataset*
```{r}
data <- read.csv("./data/MHD_WD.csv",  colClasses = c("Pop_density_CAT" = "factor", "Hardiness2" = "factor", "Infection_Severity" = "factor", "Month"= "factor", "Year"= "factor"))
```


Graph the relationship between infection and day of year to visually inspect the relationship for linearity. 
```{r}
#Convert variables into different forms for graphing purposes
data$Day_Year<-as.factor(data$Day_Year)
data$Infection_Severity<-as.numeric(data$Infection_Severity)

#Calculate the probability of infection on each day of year 
 library(plyr)
r2<-ddply(data,.(Day_Year), summarize, mean=mean(Infection_Severity))
r3<- (r2$mean)-1
r2$r3 <- r3

#Plot 
plot(r2$Day_Year, r2$r3, xlab = "Day of Year", ylab = "Probability of Infection")

library(ggplot2)
ggplot(data=r2, aes(x=as.numeric(Day_Year), r3))+geom_point() + geom_smooth()

```

Graph the relationship between infection and year to visually inspect the relationship for linearity. 

```{r}
#Convert variables into different forms for graphing purposes
data$Season<-revalue(data$Season, c("11_12"="1", "12_13"="2", "13_14"="3", "14_15"="4", "15_16"="5", "16_17"="6", "17_18"="7"))

class(data$Season)

data$Infection_Severity<-as.numeric(data$Infection_Severity)


#Calculate the probability of infection on each day of year 
 library(plyr)
s1<-ddply(data,.(Season), summarize, mean=mean(Infection_Severity))
s2<- (s1$mean)-1
s1$s2 <- s2

#Plot 
plot(as.numeric(s1$Season), s1$s2, xlab = "Year", ylab = "Probability of Infection", type='o')

```


*Exploring the Change in Infection Prevalence Between Years*
  
  *Hypothesis 1: Within Year*
 Within a single winter season OE infection prevalence may increase with day of year as reproductive activity and increased monarch density lead to higher rates of transmission. 
 
  
  *Hypothesis 2: Between Years*
  If the population of winterbreeding monarchs in the southeastern US is growing, we expect that OE infection prevalence may increase with year as increased monarch density leads to higher rates of transmission.



*Model Construction*
This first model is designed to characterize temporal infection patterns in the southeast by including month, year and an interaction of these two terms in a single model. 

```{r}
require(mgcv)

#Ensure variables are of the correct type for model construction 
data$Day_Year<-as.numeric(data$Day_Year)
data$Season<-as.numeric(data$Season)

data$Infection_Severity<-as.factor(data$Infection_Severity)

# Fit the model
gam_mod <- gam(Infection_Severity ~ te(Day_Year, Season, k =4) + Day_Year + Season + s(Volunteer.x, bs="re"), family = binomial, method = "REML", data = data)

gam_mod.2 <- gam(Infection_Severity ~ te(Day_Year, Season, k =4) + s(Day_Year) + s(Season,k=4) + s(Volunteer.x, bs="re"), family = binomial, method = "REML", data = data)

summary(gam_mod)
summary(gam_mod.2)

```

*Summarize output of model*

```{r}
summary(gam_mod)                 

```


The model output summary tells us that the additive temporal variables explain 36.7% of the deviance.We also can convert the outputs from the model to actual probabilities because the GAM model uses a log-odds scale for estimating outputs. After converting the intercept estimate below we find that the model predicts a 63.8% chance of infection overall. 

```{r}
plogis(0.5688)
```


*Checking the Model*
```{r}
gam.check(gam_mod)
```


                 

*Plot the results of the temporal model* 

```{r}
#install.packages("mgcViz")
require(mgcViz)

#Figures with probabilities along y axis 

plot(gam_mod, pages = 1, trans = plogis,
     shift = coef(gam_mod)[1], seWithMean = TRUE)

#Partial effects plots with 95% confidence intervals

b <- getViz(gam_mod.2, trans = plogis)
print(plot(b, allTerms = T), pages = 1)
```

*Research Question 2*
How do the listed exogenous variables impact the spatial dynamics of OE infection prevalence change within year and between years in the sedentary population of monarch butterflies in the SE U.S.?
  1. Human population density 
  2. Monarch larval density 
  3. Temperature 
  4. Precipitation
  

*Environmental Variables Model* 
In the Brown et al. paper, they used the GAMs in the previous step to determine the end of season infection prevalence for each year. They then looked for "bivariate correlations" between these infection prevalences and different environmental variables. 

Can I build a GAM to look at how infection varies with temperature, monarch density and other variables within and between years?


*Research Question 3*
How do the observed patterns in infection dynamics differ by sex?
